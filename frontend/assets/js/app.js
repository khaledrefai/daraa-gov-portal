const state = {
  currentUser: null,
  selectedCategory: 'ุงููู',
  selectedService: null,
  otpPhone: null,
};

const elements = {
  servicesList: document.getElementById('servicesList'),
  serviceDetails: document.getElementById('serviceDetails'),
  categoryFilters: document.getElementById('categoryFilters'),
  heroStats: document.getElementById('heroStats'),
  complaintsPanel: document.getElementById('complaintsPanel'),
  requestsPanel: document.getElementById('requestsPanel'),
  suggestionsPanel: document.getElementById('suggestionsPanel'),
  violationsPanel: document.getElementById('violationsPanel'),
  authModal: document.getElementById('authModal'),
  toast: document.getElementById('toast'),
  loginForm: document.getElementById('loginForm'),
  registerForm: document.getElementById('registerForm'),
  otpForm: document.getElementById('otpForm'),
  userActions: document.querySelector('.user-actions'),
};

const updateUserActions = () => {
  if (!elements.userActions) return;

  if (state.currentUser) {
    elements.userActions.innerHTML = `
      <div class="badge">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5Z"/></svg>
        <span>${state.currentUser.fullName}</span>
      </div>
      <button class="btn btn-outline" id="logoutBtn">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
    `;
    elements.userActions.querySelector('#logoutBtn').addEventListener('click', () => {
      state.currentUser = null;
      showToast('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ.');
      updateUserActions();
      loadComplaints();
      loadRequests();
    });
  } else {
    elements.userActions.innerHTML = `
      <button class="btn btn-outline" id="loginTrigger">ุชุณุฌูู ุงูุฏุฎูู</button>
      <button class="btn" id="registerTrigger">ุฅูุดุงุก ุญุณุงุจ</button>
    `;
    initAuthTriggers();
  }
};

const showToast = (message, duration = 3000) => {
  elements.toast.textContent = message;
  elements.toast.classList.add('show');
  setTimeout(() => elements.toast.classList.remove('show'), duration);
};

const toggleModal = (open = true) => {
  if (open) {
    elements.authModal.classList.add('open');
    elements.authModal.setAttribute('aria-hidden', 'false');
  } else {
    elements.authModal.classList.remove('open');
    elements.authModal.setAttribute('aria-hidden', 'true');
    switchAuthTab('login');
    state.otpPhone = null;
  }
};

const switchAuthTab = (tab) => {
  const tabs = elements.authModal.querySelectorAll('.modal__tab');
  const forms = elements.authModal.querySelectorAll('[data-tab-content]');

  tabs.forEach((btn) => btn.classList.toggle('active', btn.dataset.tab === tab));
  forms.forEach((form) => {
    form.classList.toggle('hidden', form.dataset.tabContent !== tab);
  });

  const subtitle = {
    login: 'ุณุฌูู ุงูุฏุฎูู ูููุตูู ููุงูุฉ ุงูุฎุฏูุงุช',
    register: 'ุฃูุดุฆ ุญุณุงุจุงู ุฌุฏูุฏุงู ูุชูุนูู ุงูุฎุฏูุงุช ุงูุฅููุชุฑูููุฉ',
    otp: 'ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ููุฑุฉ ูุงุญุฏุฉ ุงููุฑุณูุฉ ุฅูู ูุงุชูู',
  };
  document.getElementById('authSubtitle').textContent = subtitle[tab];
};

const renderHeroStats = (services) => {
  const stats = [
    { label: 'ุฎุฏูุงุช ูุชุงุญุฉ ุฅููุชุฑูููุงู', value: services.filter((s) => s.online).length },
    { label: 'ุชุตูููุงุช ุงูุฎุฏูุฉ', value: new Set(services.map((s) => s.category)).size },
    { label: 'ุฒูู ุงูุงุณุชุฌุงุจุฉ ุงููุชูุณุท', value: '48 ุณุงุนุฉ' },
  ];
  elements.heroStats.innerHTML = stats
    .map(
      (stat) => `
      <div class="stat">
        <span>${stat.label}</span>
        <strong>${stat.value}</strong>
      </div>
    `
    )
    .join('');
};

const renderFilters = (services) => {
  const categories = ['ุงููู', ...new Set(services.map((service) => service.category))];
  elements.categoryFilters.innerHTML = categories
    .map(
      (category) => `
      <button class="filter ${state.selectedCategory === category ? 'active' : ''}" data-category="${category}">
        ${category}
      </button>
    `
    )
    .join('');
};

const renderServices = (services) => {
  const filtered = state.selectedCategory === 'ุงููู'
    ? services
    : services.filter((service) => service.category === state.selectedCategory);

  elements.servicesList.innerHTML = filtered
    .map(
      (service) => `
      <article class="service-card ${state.selectedService === service.id ? 'active' : ''}" data-service-id="${service.id}">
        <h4>${service.title}</h4>
        <p>${service.description}</p>
        <div class="taglist">
          ${service.tags.map((tag) => `<span>${tag}</span>`).join('')}
        </div>
      </article>
    `
    )
    .join('');

  if (!filtered.length) {
    elements.servicesList.innerHTML = '<p class="empty-state">ูุง ุชูุฌุฏ ุฎุฏูุงุช ุถูู ูุฐุง ุงูุชุตููู ุญุงููุงู.</p>';
  }
};

const renderServiceDetails = async (serviceId) => {
  if (!serviceId) {
    elements.serviceDetails.innerHTML = `
      <div class="empty-state">
        <h4>ุงุฎุชุฑ ุฎุฏูุฉ ููุงุทูุงุน ุนูู ุชูุงุตูููุง</h4>
        <p>ุงุถุบุท ุนูู ุฃู ุฎุฏูุฉ ูู ุงููุงุฆูุฉ ูุงุณุชุนุฑุงุถ ุงููุตูุ ูุณุงุฑ ุงูุนููุ ูููุงุช ุงูุชูุงุตูุ ูุฅููุงููุฉ ุงูุชูุฏูู ุงูุฅููุชุฑููู.</p>
      </div>
    `;
    return;
  }

  try {
    const service = await MockApi.getServiceById(serviceId);
    state.selectedService = serviceId;

    const workflowList = service.workflow.map((step) => `<li>${step}</li>`).join('');

    elements.serviceDetails.innerHTML = `
      <div class="detail-header">
        <h4>${service.title}</h4>
        <span class="tag">${service.category}</span>
      </div>
      <p>${service.description}</p>
      <h5>ูุณุงุฑ ุงูุนูู</h5>
      <ul>${workflowList}</ul>
      <h5>ูููุงุช ุงูุชูุงุตู</h5>
      <ul>
        <li>๐ ${service.contact.phone}</li>
        <li>โ๏ธ ${service.contact.email}</li>
        <li>๐ ${service.contact.address}</li>
      </ul>
      ${service.online
        ? '<button class="btn" id="applyService">ุงูุชูุฏูู ุนูู ุงูุฎุฏูุฉ ุฅููุชุฑูููุงู</button>'
        : '<p class="empty-state">ูุฐู ุงูุฎุฏูุฉ ุชุชุทูุจ ุงูุญุถูุฑ ุงูุดุฎุตู ุญุงููุงู.</p>'}
    `;

    elements.serviceDetails.querySelector('#applyService')?.addEventListener('click', handleApplyService);
  } catch (error) {
    showToast(error.message);
  }
};

const statusLabels = {
  pending: 'ุจุงูุชุธุงุฑ ุงููุฑุงุฌุนุฉ',
  'in-progress': 'ููุฏ ุงููุนุงูุฌุฉ',
  completed: 'ููุฌุฒุฉ',
  rejected: 'ูุฑููุถุฉ',
};

const renderComplaints = (items = []) => {
  elements.complaintsPanel.innerHTML = `
    <h4>ุณุฌู ุงูุดูุงูู</h4>
    <form id="complaintForm" class="form-grid">
      <label>
        <span>ููุถูุน ุงูุดููู</span>
        <input type="text" name="subject" required />
      </label>
      <label>
        <span>ุงูุชุตููู</span>
        <input type="text" name="category" placeholder="ูุซุงู: ููุงูุ ููุฑุจุงุก" required />
      </label>
      <label>
        <span>ุชูุงุตูู ุงูุดููู</span>
        <textarea name="details" required></textarea>
      </label>
      <button class="btn" type="submit">ุฅุฑุณุงู ุงูุดููู</button>
    </form>
    ${items.length
      ? `
        <table class="table">
          <thead>
            <tr>
              <th>ุงููุนุฑู</th>
              <th>ุงูููุถูุน</th>
              <th>ุงูุชุตููู</th>
              <th>ุงูุญุงูุฉ</th>
              <th>ุชุญุฏูุซุงุช</th>
            </tr>
          </thead>
          <tbody>
            ${items
              .map(
                (item) => `
                  <tr>
                    <td>${item.id}</td>
                    <td>${item.subject}</td>
                    <td>${item.category}</td>
                    <td><span class="status-tag ${item.status}">${statusLabels[item.status]}</span></td>
                    <td>${item.updates
                      .map((update) => `<div>${update.date} - ${update.note}</div>`)
                      .join('')}</td>
                  </tr>
                `
              )
              .join('')}
          </tbody>
        </table>
      `
      : '<p class="empty-state">ูู ุชูู ุจุชุณุฌูู ุฃู ุดููู ุจุนุฏ.</p>'}
  `;

  elements.complaintsPanel.classList.add('active');
  elements.complaintsPanel.querySelector('#complaintForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!state.currentUser) return requireAuth();

    const formData = new FormData(event.target);
    const payload = Object.fromEntries(formData.entries());

    try {
      await MockApi.submitComplaint(state.currentUser.id, payload);
      showToast('ุชู ุชุณุฌูู ุงูุดููู ุจูุฌุงุญ.');
      loadComplaints();
      event.target.reset();
    } catch (error) {
      showToast(error.message);
    }
  });
};

const renderRequests = (items = []) => {
  elements.requestsPanel.innerHTML = `
    <h4>ูุชุงุจุนุฉ ุงูุทูุจุงุช</h4>
    <form id="requestForm" class="form-grid">
      <label>
        <span>ููุถูุน ุงูุทูุจ</span>
        <input type="text" name="subject" required />
      </label>
      <label>
        <span>ุงูุฌูุฉ ุงููุนููุฉ</span>
        <input type="text" name="department" required />
      </label>
      <label>
        <span>ุชูุงุตูู ุงูุทูุจ</span>
        <textarea name="details" required></textarea>
      </label>
      <button class="btn" type="submit">ุฅุฑุณุงู ุงูุทูุจ</button>
    </form>
    ${items.length
      ? `
        <table class="table">
          <thead>
            <tr>
              <th>ุงููุนุฑู</th>
              <th>ุงูููุถูุน</th>
              <th>ุงูุฌูุฉ</th>
              <th>ุงูุญุงูุฉ</th>
              <th>ุชุงุฑูุฎ ุงูุชูุฏูู</th>
            </tr>
          </thead>
          <tbody>
            ${items
              .map(
                (item) => `
                  <tr>
                    <td>${item.id}</td>
                    <td>${item.subject}</td>
                    <td>${item.department}</td>
                    <td><span class="status-tag ${item.status}">${statusLabels[item.status]}</span></td>
                    <td>${item.createdAt}</td>
                  </tr>
                `
              )
              .join('')}
          </tbody>
        </table>
      `
      : '<p class="empty-state">ูู ูุชู ุฅุฑุณุงู ุฃู ุทูุจ ุญุชู ุงูุขู.</p>'}
  `;

  elements.requestsPanel.classList.add('active');
  elements.requestsPanel.querySelector('#requestForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!state.currentUser) return requireAuth();

    const payload = Object.fromEntries(new FormData(event.target).entries());

    try {
      await MockApi.submitRequest(state.currentUser.id, payload);
      showToast('ุชู ุฅุฑุณุงู ุงูุทูุจ ุจูุฌุงุญ.');
      loadRequests();
      event.target.reset();
    } catch (error) {
      showToast(error.message);
    }
  });
};

const renderSuggestions = async () => {
  const items = await MockApi.getSuggestions();

  elements.suggestionsPanel.innerHTML = `
    <h4>ุฎุฏูุฉ ุงูุงูุชุฑุงุญุงุช</h4>
    <form id="suggestionForm" class="form-grid">
      <label>
        <span>ุนููุงู ุงูุงูุชุฑุงุญ</span>
        <input type="text" name="title" required />
      </label>
      <label>
        <span>ูุตู ูุฎุชุตุฑ</span>
        <textarea name="body" required></textarea>
      </label>
      <button class="btn" type="submit">ุฅุฑุณุงู ุงูุงูุชุฑุงุญ</button>
    </form>
    ${items.length
      ? `
        <table class="table">
          <thead>
            <tr>
              <th>ุงูุนููุงู</th>
              <th>ุงููุตู</th>
              <th>ุงูุชุงุฑูุฎ</th>
            </tr>
          </thead>
          <tbody>
            ${items
              .map(
                (item) => `
                  <tr>
                    <td>${item.title}</td>
                    <td>${item.body}</td>
                    <td>${item.createdAt}</td>
                  </tr>
                `
              )
              .join('')}
          </tbody>
        </table>
      `
      : '<p class="empty-state">ูุง ุชูุฌุฏ ุงูุชุฑุงุญุงุช ุจุนุฏุ ูู ุฃูู ูู ูุดุงุฑู ุฑุฃูู.</p>'}
  `;

  elements.suggestionsPanel.classList.add('active');
  elements.suggestionsPanel.querySelector('#suggestionForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    const payload = Object.fromEntries(new FormData(event.target).entries());
    try {
      await MockApi.submitSuggestion(payload);
      showToast('ุดูุฑุงู ููุณุงููุชู!');
      renderSuggestions();
      event.target.reset();
    } catch (error) {
      showToast(error.message);
    }
  });
};

const renderViolations = async () => {
  const items = await MockApi.getViolations();
  const total = items.reduce((sum, item) => sum + item.amount, 0);

  elements.violationsPanel.innerHTML = `
    <h4>ุงููุฎุงููุงุช ุงููุณุฌูุฉ</h4>
    <p>ููููู ุงุณุชุนุฑุงุถ ุงููุฎุงููุงุช ูุงูุฏูุน ุงูุฅููุชุฑููู ุนูุฏ ุชููุฑู.</p>
    ${items.length
      ? `
        <table class="table">
          <thead>
            <tr>
              <th>ุงูุฑูู</th>
              <th>ุงูููุน</th>
              <th>ุงููุตู</th>
              <th>ุงููููุฉ (ู.ุณ)</th>
              <th>ุงูุญุงูุฉ</th>
              <th>ุชุงุฑูุฎ ุงููุฎุงููุฉ</th>
            </tr>
          </thead>
          <tbody>
            ${items
              .map(
                (item) => `
                  <tr>
                    <td>${item.id}</td>
                    <td>${item.type}</td>
                    <td>${item.description}</td>
                    <td>${item.amount.toLocaleString('ar-SY')}</td>
                    <td>${item.status}</td>
                    <td>${item.issuedAt}</td>
                  </tr>
                `
              )
              .join('')}
          </tbody>
        </table>
        <div class="detail-header" style="margin-top:1.5rem;">
          <span class="tag">ุฅุฌูุงูู ุงูุฐูู</span>
          <strong>${total.toLocaleString('ar-SY')} ู.ุณ</strong>
        </div>
      `
      : '<p class="empty-state">ูุง ุชูุฌุฏ ูุฎุงููุงุช ูุณุฌูุฉ.</p>'}
  `;

  elements.violationsPanel.classList.add('active');
};

const requireAuth = () => {
  showToast('ุงูุฑุฌุงุก ุชุณุฌูู ุงูุฏุฎูู ูุฅุชูุงู ูุฐู ุงูุนูููุฉ.');
  toggleModal(true);
};

const handleApplyService = () => {
  if (!state.currentUser) {
    requireAuth();
    return;
  }
  showToast('ุชู ุชููุฆุฉ ุทูุจู ููุฎุฏูุฉุ ุณูุฌุฑู ุชุญูููู ููุงุฌูุฉ ุงูุชูุฏูู ูุฑูุจุงู.');
};

const loadComplaints = async () => {
  if (!state.currentUser) {
    renderComplaints();
    return;
  }
  const items = await MockApi.getComplaints(state.currentUser.id);
  renderComplaints(items);
};

const loadRequests = async () => {
  if (!state.currentUser) {
    renderRequests();
    return;
  }
  const items = await MockApi.getRequests(state.currentUser.id);
  renderRequests(items);
};

const initPanels = async () => {
  await loadComplaints();
  await loadRequests();
  await renderSuggestions();
  await renderViolations();
};

const initAuthTriggers = () => {
  const loginTrigger = document.getElementById('loginTrigger');
  const registerTrigger = document.getElementById('registerTrigger');
  loginTrigger?.addEventListener('click', () => {
    switchAuthTab('login');
    toggleModal(true);
  });

  registerTrigger?.addEventListener('click', () => {
    switchAuthTab('register');
    toggleModal(true);
  });
};

const initAuth = () => {
  elements.authModal.addEventListener('click', (event) => {
    if (event.target.dataset.close !== undefined || event.target === elements.authModal) {
      toggleModal(false);
    }
  });

  elements.authModal.querySelectorAll('.modal__tab').forEach((tab) => {
    tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab));
  });

  elements.loginForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const { phone, password } = Object.fromEntries(new FormData(event.target).entries());
    try {
      const user = await MockApi.login(phone, password);
      state.currentUser = user;
      toggleModal(false);
      showToast(`ูุฑุญุจุงู ุจู ${user.fullName}!`);
      loadComplaints();
      loadRequests();
      updateUserActions();
    } catch (error) {
      showToast(error.message);
    }
  });

  elements.registerForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const payload = Object.fromEntries(new FormData(event.target).entries());
    try {
      const { phone, otp } = await MockApi.register(payload);
      state.otpPhone = phone;
      switchAuthTab('otp');
      const hint = elements.otpForm.querySelector('.otp__hint');
      hint.textContent = `ุชู ุฅุฑุณุงู ูููุฉ ูุฑูุฑ ููุฑุฉ ูุงุญุฏุฉ ุฅูู ุงูุฑูู ${phone}. (ุฑูุฒ ุชุฌุฑูุจู: ${otp})`;
    } catch (error) {
      showToast(error.message);
    }
  });

  elements.otpForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const { otp } = Object.fromEntries(new FormData(event.target).entries());
    if (!state.otpPhone) return;

    try {
      const user = await MockApi.verifyOtp(state.otpPhone, otp);
      state.currentUser = user;
      state.otpPhone = null;
      switchAuthTab('login');
      toggleModal(false);
      showToast('ุชู ุชูุนูู ุงูุญุณุงุจ ุจูุฌุงุญ! ููููู ุงูุขู ุงุณุชุฎุฏุงู ุงูููุตุฉ.');
      loadComplaints();
      loadRequests();
      updateUserActions();
    } catch (error) {
      showToast(error.message);
    }
  });
};

const initNavigationCards = () => {
  document.querySelectorAll('.card').forEach((card) => {
    card.addEventListener('click', () => {
      const target = card.dataset.target;
      const panel = document.getElementById(`${target}Panel`);
      if (!panel) return;
      panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      panel.classList.add('active');
    });
  });
};

const initServices = async () => {
  try {
    const services = await MockApi.getServices();
    state.services = services;
    renderHeroStats(services);
    renderFilters(services);
    renderServices(services);
    renderServiceDetails(state.selectedService);

    elements.categoryFilters.addEventListener('click', (event) => {
      if (event.target.matches('.filter')) {
        state.selectedCategory = event.target.dataset.category;
        renderFilters(state.services);
        renderServices(state.services);
        renderServiceDetails(null);
      }
    });

    elements.servicesList.addEventListener('click', (event) => {
      const card = event.target.closest('[data-service-id]');
      if (!card) return;
      const serviceId = card.dataset.serviceId;
      renderServiceDetails(serviceId);
      renderServices(state.services);
    });
  } catch (error) {
    showToast('ุชุนุฐุฑ ุชุญููู ุงูุฎุฏูุงุช ุญุงููุงู.');
    console.error(error);
  }
};

const initCTAButtons = () => {
  document.getElementById('exploreServices').addEventListener('click', () => {
    document.getElementById('servicesSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  });

  document.getElementById('contactSupport').addEventListener('click', () => {
    window.location.href = 'tel:015123456';
  });
};

const init = async () => {
  updateUserActions();
  initAuth();
  initNavigationCards();
  initCTAButtons();
  await initServices();
  await initPanels();
};

window.addEventListener('DOMContentLoaded', init);
